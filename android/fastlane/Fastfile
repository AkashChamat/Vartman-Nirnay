default_platform(:android)

platform :android do
  before_all do
    # Ensure the AAB file exists
    aab_path = File.expand_path("../app/build/outputs/bundle/release/app-release.aab", __dir__)
    unless File.exist?(aab_path)
      UI.user_error!("âŒ AAB file not found at #{aab_path}. Please build the project first.")
    end
    ENV['AAB_PATH'] = aab_path

    # Ensure Play Store key file exists
    json_key_path = ENV['JSON_KEY_PATH'] || File.expand_path("play-store-key.json", __dir__)
    unless File.exist?(json_key_path)
      UI.user_error!("âŒ Play Store JSON key not found at #{json_key_path}")
    end
    ENV['JSON_KEY_PATH'] = json_key_path

    UI.success("âœ… Pre-flight checks passed")
  end

  desc "Deploy to Play Store Internal Testing"
  lane :internal do
    UI.message("ğŸš€ Deploying to Internal Testing...")

    upload_to_play_store(
      track: 'internal',
      json_key: ENV['JSON_KEY_PATH'],
      aab: ENV['AAB_PATH'],
      package_name: ENV['PACKAGE_NAME'] || 'com.vartmannew',
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      release_status: 'completed',
      timeout: 300
    )

    UI.success("ğŸ‰ Successfully deployed to Internal Testing!")
  end

  desc "Deploy to Play Store Alpha Testing"
  lane :alpha do
    UI.message("ğŸš€ Deploying to Alpha Testing...")

    upload_to_play_store(
      track: 'alpha',
      json_key: ENV['JSON_KEY_PATH'],
      aab: ENV['AAB_PATH'],
      package_name: ENV['PACKAGE_NAME'] || 'com.vartmannew',
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      release_status: 'completed',
      timeout: 300
    )

    UI.success("ğŸ‰ Successfully deployed to Alpha Testing!")
  end

  desc "Deploy to Play Store Beta Testing"
  lane :beta do
    UI.message("ğŸš€ Deploying to Beta Testing...")

    upload_to_play_store(
      track: 'beta',
      json_key: ENV['JSON_KEY_PATH'],
      aab: ENV['AAB_PATH'],
      package_name: ENV['PACKAGE_NAME'] || 'com.vartmannew',
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      release_status: 'completed',
      timeout: 300
    )

    UI.success("ğŸ‰ Successfully deployed to Beta Testing!")
  end

  desc "Deploy to Play Store Production"
  lane :production do
    UI.message("ğŸš€ Deploying to Production...")
    UI.confirm("âš ï¸ Are you sure you want to deploy to Production?")

    upload_to_play_store(
      track: 'production',
      json_key: ENV['JSON_KEY_PATH'],
      aab: ENV['AAB_PATH'],
      package_name: ENV['PACKAGE_NAME'] || 'com.vartmannew',
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      release_status: 'completed',
      timeout: 300
    )

    UI.success("ğŸ‰ Successfully deployed to Production!")
  end

  desc "Promote from Internal to Alpha"
  lane :promote_internal_to_alpha do
    UI.message("ğŸ”„ Promoting from Internal to Alpha...")

    upload_to_play_store(
      track: 'internal',
      track_promote_to: 'alpha',
      json_key: ENV['JSON_KEY_PATH'],
      package_name: ENV['PACKAGE_NAME'] || 'com.vartmannew',
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      timeout: 300
    )

    UI.success("ğŸ‰ Successfully promoted to Alpha!")
  end

  desc "Promote from Alpha to Beta"
  lane :promote_alpha_to_beta do
    UI.message("ğŸ”„ Promoting from Alpha to Beta...")

    upload_to_play_store(
      track: 'alpha',
      track_promote_to: 'beta',
      json_key: ENV['JSON_KEY_PATH'],
      package_name: ENV['PACKAGE_NAME'] || 'com.vartmannew',
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      timeout: 300
    )

    UI.success("ğŸ‰ Successfully promoted to Beta!")
  end

  desc "Promote from Beta to Production"
  lane :promote_beta_to_production do
    UI.message("ğŸ”„ Promoting from Beta to Production...")
    UI.confirm("âš ï¸ Are you sure you want to promote to Production?")

    upload_to_play_store(
      track: 'beta',
      track_promote_to: 'production',
      json_key: ENV['JSON_KEY_PATH'],
      package_name: ENV['PACKAGE_NAME'] || 'com.vartmannew',
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      timeout: 300
    )

    UI.success("ğŸ‰ Successfully promoted to Production!")
  end

  desc "Get app info from Play Store"
  lane :app_info do
    UI.message("ğŸ“± Fetching app info from Play Store...")

    version_info = google_play_track_version_codes(
      json_key: ENV['JSON_KEY_PATH'],
      package_name: ENV['PACKAGE_NAME'] || 'com.vartmannew'
    )

    UI.message("Current version codes:")
    version_info.each do |track, versions|
      UI.message("#{track}: #{versions}")
    end
  end

  desc "Increment version code"
  lane :increment_version do
    increment_version_code(
      gradle_file_path: "../app/build.gradle"
    )
  end

  after_all do |lane|
    UI.success("âœ… Lane #{lane} completed successfully!")
  end

  error do |lane, exception|
    UI.error("âŒ Lane #{lane} failed with error: #{exception.message}")
  end
end
