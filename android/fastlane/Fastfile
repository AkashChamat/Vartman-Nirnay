# Disable analytics prompts
opt_out_usage

default_platform(:android)

platform :android do
  before_all do
    UI.message("üöÄ Starting Fastlane deployment process...")

    # Path to Play Store service account JSON
    ENV['JSON_KEY_PATH'] ||= File.join(__dir__, "play-store-key.json")
    UI.message("Using JSON key: #{ENV['JSON_KEY_PATH']}")
    unless File.exist?(ENV['JSON_KEY_PATH'])
      UI.user_error!("‚ùå Play Store JSON key not found at #{ENV['JSON_KEY_PATH']}")
    end

    # Gradle wrapper path
    ENV['GRADLE_WRAPPER'] ||= File.expand_path("../gradlew", __dir__)
    ENV['PROJECT_DIR'] ||= File.expand_path("../", __dir__)
    ENV['PACKAGE_NAME'] ||= "com.vartmannew"
  end

  # Helper to build and upload AAB
  def build_and_upload(track, skip_metadata: false, build_type: "release")
    UI.header("üì¶ Building and deploying #{track} (#{build_type})")

    # Determine Gradle build type
    gradle_build_type = build_type.downcase == "internal" ? "release" : build_type.downcase
    UI.message("Gradle build type: #{gradle_build_type}")

    # Build the AAB first to generate the merged manifest
    gradle(
      task: "bundle",
      build_type: gradle_build_type.capitalize,
      project_dir: ENV['PROJECT_DIR'],
      gradle_path: ENV['GRADLE_WRAPPER']
    )

    # Path to merged manifest for the variant
    merged_manifest_dir = File.join(
      ENV['PROJECT_DIR'],
      "app/build/intermediates/merged_manifests/#{gradle_build_type}"
    )

    # Look for the actual manifest in process*Manifest folder
    merged_manifest_path = Dir.glob("#{merged_manifest_dir}/process*Manifest/AndroidManifest.xml").first
    UI.message("üìã Checking AD_ID permission in merged manifest: #{merged_manifest_path}")

    unless merged_manifest_path && File.exist?(merged_manifest_path) &&
           File.read(merged_manifest_path).include?("com.google.android.gms.permission.AD_ID")
      UI.user_error!("‚ùå AD_ID permission missing in merged AndroidManifest.xml!")
    end

    # Path to AAB file
    aab_path = File.join(
      ENV['PROJECT_DIR'],
      "app/build/outputs/bundle/#{gradle_build_type}/app-#{gradle_build_type}.aab"
    )
    UI.message("Looking for AAB at: #{aab_path}")

    unless File.exist?(aab_path)
      UI.user_error!("‚ùå AAB file not found at #{aab_path}")
    end

    # Upload to Play Store
    upload_to_play_store(
      track: track,
      json_key: ENV['JSON_KEY_PATH'],
      aab: aab_path,
      package_name: ENV['PACKAGE_NAME'],
      skip_upload_apk: true,
      skip_upload_metadata: skip_metadata,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      release_status: 'completed'
    )

    UI.success("üéâ Successfully deployed to #{track}")
  end

  # Lane: Internal Testing
  desc "Deploy to Internal Testing"
  lane :internal do
    build_and_upload('internal', skip_metadata: true, build_type: "internal")
  end

  # Lane: Alpha
  desc "Deploy to Alpha"
  lane :alpha do
    build_and_upload('alpha', skip_metadata: false, build_type: "release")
  end

  # Lane: Beta
  desc "Deploy to Beta"
  lane :beta do
    build_and_upload('beta', skip_metadata: false, build_type: "release")
  end

  # Lane: Production
  desc "Deploy to Production"
  lane :production do
    build_and_upload('production', skip_metadata: false, build_type: "release")
  end

  after_all do |lane|
    UI.success("‚úÖ Lane #{lane} completed successfully!")
  end

  error do |lane, exception|
    UI.error("‚ùå Lane #{lane} failed with error: #{exception.message}")
  end
end
