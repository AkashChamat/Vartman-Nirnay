# Disable analytics prompts
opt_out_usage

default_platform(:android)

platform :android do
  before_all do
    UI.message("üöÄ Starting Fastlane deployment process...")

    ENV['JSON_KEY_PATH'] ||= File.expand_path("play-store-key.json", __dir__)
    unless File.exist?(ENV['JSON_KEY_PATH'])
      UI.user_error!("‚ùå Play Store JSON key not found at #{ENV['JSON_KEY_PATH']}")
    end

    ENV['GRADLE_WRAPPER'] ||= File.expand_path(Gem.win_platform? ? "gradlew.bat" : "gradlew", "../")
    ENV['PROJECT_DIR'] ||= File.expand_path("../", __dir__)
    ENV['PACKAGE_NAME'] ||= "com.vartmannew"
  end

  # Build and upload helper
  def build_and_upload(track, skip_metadata: false, build_type: "release")
    UI.header("üì¶ Building and deploying #{track} (#{build_type})")

    gradle(
      task: "bundle",
      build_type: build_type.capitalize,
      project_dir: ENV['PROJECT_DIR'],
      gradle_path: ENV['GRADLE_WRAPPER']
    )

    aab_path = File.join(ENV['PROJECT_DIR'], "app/build/outputs/bundle/#{build_type}/app-#{build_type}.aab")
    unless File.exist?(aab_path)
      UI.user_error!("‚ùå AAB file not found at #{aab_path}")
    end

    upload_to_play_store(
      track: track,
      json_key: ENV['JSON_KEY_PATH'],
      aab: aab_path,
      package_name: ENV['PACKAGE_NAME'],
      skip_upload_apk: true,
      skip_upload_metadata: skip_metadata,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      release_status: 'completed'
    )

    UI.success("üéâ Successfully deployed to #{track}")
  end

  desc "Deploy to Internal Testing"
  lane :internal do
    build_and_upload('internal', skip_metadata: true, build_type: "internal")
  end

  desc "Deploy to Alpha"
  lane :alpha do
    build_and_upload('alpha')
  end

  desc "Deploy to Beta"
  lane :beta do
    build_and_upload('beta')
  end

  desc "Deploy to Production"
  lane :production do
    build_and_upload('production')
  end

  after_all do |lane|
    UI.success("‚úÖ Lane #{lane} completed successfully!")
  end

  error do |lane, exception|
    UI.error("‚ùå Lane #{lane} failed with error: #{exception.message}")
  end
end
