# Disable analytics prompts
opt_out_usage

default_platform(:android)

platform :android do

  # âœ… Pre-flight checks before any lane runs
  before_all do
    # AAB path
    aab_path = ENV['AAB_PATH'] || File.expand_path("../app/build/outputs/bundle/release/app-release.aab", __dir__)
    unless File.exist?(aab_path)
      UI.user_error!("âŒ AAB file not found at #{aab_path}. Please build the project first.")
    end
    ENV['AAB_PATH'] = aab_path

    # Play Store JSON key
    json_key_path = ENV['JSON_KEY_PATH'] || File.expand_path("play-store-key.json", __dir__)
    unless File.exist?(json_key_path)
      UI.user_error!("âŒ Play Store JSON key not found at #{json_key_path}")
    end
    ENV['JSON_KEY_PATH'] = json_key_path

    UI.success("âœ… Pre-flight checks passed")
  end

  ###############
  # Deployment Lanes
  ###############

  desc "Deploy to Internal Testing"
  lane :internal do
    upload_to_play_store(
      track: 'internal',
      json_key: ENV['JSON_KEY_PATH'],
      aab: ENV['AAB_PATH'],
      package_name: ENV['PACKAGE_NAME'],
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      release_status: 'completed'
    )
    UI.success("ğŸ‰ Successfully deployed to Internal Testing!")
  end

  desc "Deploy to Alpha Testing"
  lane :alpha do
    upload_to_play_store(
      track: 'alpha',
      json_key: ENV['JSON_KEY_PATH'],
      aab: ENV['AAB_PATH'],
      package_name: ENV['PACKAGE_NAME'],
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      release_status: 'completed'
    )
    UI.success("ğŸ‰ Successfully deployed to Alpha Testing!")
  end

  desc "Deploy to Beta Testing"
  lane :beta do
    upload_to_play_store(
      track: 'beta',
      json_key: ENV['JSON_KEY_PATH'],
      aab: ENV['AAB_PATH'],
      package_name: ENV['PACKAGE_NAME'],
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      release_status: 'completed'
    )
    UI.success("ğŸ‰ Successfully deployed to Beta Testing!")
  end

  desc "Deploy to Production"
  lane :production do
    upload_to_play_store(
      track: 'production',
      json_key: ENV['JSON_KEY_PATH'],
      aab: ENV['AAB_PATH'],
      package_name: ENV['PACKAGE_NAME'],
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      release_status: 'completed'
    )
    UI.success("ğŸ‰ Successfully deployed to Production!")
  end

  ###############
  # Promotion Lanes
  ###############

  desc "Promote Internal â†’ Alpha"
  lane :promote_internal_to_alpha do
    upload_to_play_store(
      track: 'internal',
      track_promote_to: 'alpha',
      json_key: ENV['JSON_KEY_PATH'],
      package_name: ENV['PACKAGE_NAME'],
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
    UI.success("ğŸ‰ Promoted Internal â†’ Alpha!")
  end

  desc "Promote Alpha â†’ Beta"
  lane :promote_alpha_to_beta do
    upload_to_play_store(
      track: 'alpha',
      track_promote_to: 'beta',
      json_key: ENV['JSON_KEY_PATH'],
      package_name: ENV['PACKAGE_NAME'],
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
    UI.success("ğŸ‰ Promoted Alpha â†’ Beta!")
  end

  desc "Promote Beta â†’ Production"
  lane :promote_beta_to_production do
    upload_to_play_store(
      track: 'beta',
      track_promote_to: 'production',
      json_key: ENV['JSON_KEY_PATH'],
      package_name: ENV['PACKAGE_NAME'],
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
    UI.success("ğŸ‰ Promoted Beta â†’ Production!")
  end

  ###############
  # Global Hooks
  ###############

  after_all do |lane|
    UI.success("âœ… Lane #{lane} completed successfully!")
  end

  error do |lane, exception|
    UI.error("âŒ Lane #{lane} failed with error: #{exception.message}")
  end
end
