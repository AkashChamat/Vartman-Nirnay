name: Vartman Nirnay CI/CD release

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build & Deploy to Play Store
    runs-on: ubuntu-latest

    env:
      PACKAGE_NAME: com.vartmannew
      SERVICE_ACCOUNT_JSON: ${{ secrets.SERVICE_ACCOUNT_JSON }}

    steps:
      # 1. Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Setup JDK
      - name: Setup JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. Setup Android SDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v2

      # 4. Cache Gradle dependencies
      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-

      # 5. Decode keystore file
      - name: Decode keystore
        run: echo "${{ secrets.SIGNING_KEY }}" | base64 -d > android/app/upload-keystore.jks

      # 6. Set signing environment variables
      - name: Set signing env vars
        run: |
          echo "SIGNING_KEY_PATH=android/app/upload-keystore.jks" >> $GITHUB_ENV
          echo "SIGNING_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV

      # 7. Build APK / AAB
      - name: Build AAB
        run: ./gradlew bundleRelease

      # 8. Setup Fastlane
      - name: Setup Fastlane
        run: gem install fastlane

      # 9. Upload to Google Play
      - name: Upload to Google Play
        run: |
          echo "$SERVICE_ACCOUNT_JSON" > /tmp/service-account.json
          fastlane supply \
            --json_key /tmp/service-account.json \
            --package_name $PACKAGE_NAME \
            --skip_upload_images false \
            --skip_upload_screenshots false

      # 10. Clean up sensitive files
      - name: Cleanup
        if: always()
        run: |
          rm -f android/app/upload-keystore.jks
          rm -f /tmp/service-account.json
